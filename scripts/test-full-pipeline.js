const { parseWebhook } = require('../build/services/jotform.service.js');
const { generateQrCode } = require('../build/services/qr.service.js');
const { emailService } = require('../build/services/email.service.js');
require('dotenv').config({ path: require('path').resolve(__dirname, '../.env') });

console.log('üìß Stadium 25 Full Pipeline Test - Webhook ‚Üí Parse ‚Üí Email');
console.log('==========================================================');
console.log('Testing the complete flow: Webhook Data ‚Üí Field Parsing ‚Üí QR Generation ‚Üí Email Sending');

// Simulate real Stadium 25 webhook data for Bijin Johnson's 4 bookings
const simulatedWebhookData = [
  {
    // Booking 1: Friday - Invoice 000029
    formID: '251481969313867',
    rawRequest: JSON.stringify({
      q3_name: { first: 'Bijin', last: 'Johnson' },
      q4_email: 'johnson.bijin.99@gmail.com',
      q16_phone: '0412345678',
      q19_eventDate: 'Friday August 8 2025', // Key field for chooseYour
      q23_church: 'Testing Church',
      q11_invoiceId: '# INV-000029',
      q9_products: {
        paymentArray: JSON.stringify({
          product: ['General Admission (Amount: 15.00 AUD, Quantity: 1)'],
          currency: 'AUD',
          total: '15.00'
        })
      }
    })
  },
  {
    // Booking 2: Friday - Invoice 000027
    formID: '251481969313867',
    rawRequest: JSON.stringify({
      q3_name: { first: 'Bijin', last: 'Johnson' },
      q4_email: 'johnson.bijin.99@gmail.com',
      q16_phone: '0412345678',
      q19_eventDate: 'Friday August 8 2025', // Key field for chooseYour
      q23_church: 'Testing Church',
      q11_invoiceId: '# INV-000027',
      q9_products: {
        paymentArray: JSON.stringify({  
          product: ['General Admission (Amount: 15.00 AUD, Quantity: 1)'],
          currency: 'AUD',
          total: '15.00'
        })
      }
    })
  },
  {
    // Booking 3: Saturday - Invoice 000026
    formID: '251481969313867',
    rawRequest: JSON.stringify({
      q3_name: { first: 'Bijin', last: 'Johnson' },
      q4_email: 'johnson.bijin.99@gmail.com',
      q16_phone: '0412345678',
      q19_eventDate: 'Saturday August 9 2025', // Key field for chooseYour
      q23_church: 'Testing Church',
      q11_invoiceId: '# INV-000026',
      q9_products: {
        paymentArray: JSON.stringify({
          product: ['General Admission (Amount: 15.00 AUD, Quantity: 1)'],
          currency: 'AUD',
          total: '15.00'
        })
      }
    })
  },
  {
    // Booking 4: Saturday - Invoice 000025
    formID: '251481969313867',
    rawRequest: JSON.stringify({
      q3_name: { first: 'Bijin', last: 'Johnson' },
      q4_email: 'johnson.bijin.99@gmail.com',
      q16_phone: '0412345678',
      q19_eventDate: 'Saturday August 9 2025', // Key field for chooseYour
      q23_church: 'Testing Church',
      q11_invoiceId: '# INV-000025',
      q9_products: {
        paymentArray: JSON.stringify({
          product: ['General Admission (Amount: 15.00 AUD, Quantity: 1)'],
          currency: 'AUD',
          total: '15.00'
        })
      }
    })
  }
];

async function testFullPipelineForBijin() {
  console.log(`\nüîÑ Testing complete webhook processing pipeline for ${simulatedWebhookData.length} bookings...`);
  console.log('This tests: Webhook Reception ‚Üí Field Parsing ‚Üí QR Generation ‚Üí Email Sending\n');
  
  const results = [];
  
  for (let i = 0; i < simulatedWebhookData.length; i++) {
    const webhookData = simulatedWebhookData[i];
    
    try {
      console.log(`\nüìß [${i + 1}/${simulatedWebhookData.length}] Processing Webhook for Booking #${i + 1}`);
      console.log('=======================================================');
      
      // STEP 1: Parse webhook data (this tests our new chooseYour parsing)
      console.log('üîÑ STEP 1: Parsing webhook data...');
      const parsedData = parseWebhook(webhookData);
      
      console.log('‚úÖ Webhook parsed successfully:');
      console.log(`   Email: ${parsedData.email}`);
      console.log(`   Name: ${parsedData.name}`);
      console.log(`   Invoice: ${parsedData.invoiceNo}`);
      console.log(`   Phone: ${parsedData.phone}`);
      console.log(`   Church: ${parsedData.church}`);
      console.log(`   Quantity: ${parsedData.quantity}`);
      console.log(`   Choose Your Night: ${parsedData.chooseYour} üéØ`); // Key test!
      
      // Verify the chooseYour field was parsed correctly
      if (!parsedData.chooseYour) {
        throw new Error('‚ùå chooseYour field was not parsed - this is the main issue we are fixing!');
      }
      
      // STEP 2: Generate QR code
      console.log('\nüîÑ STEP 2: Generating QR code...');
      const qrDataUrl = await generateQrCode(parsedData.invoiceNo);
      console.log(`‚úÖ QR code generated for ${parsedData.invoiceNo}`);
      
      // STEP 3: Prepare email data using parsed webhook data
      console.log('\nüîÑ STEP 3: Preparing email using parsed data...');
      const emailData = {
        to: parsedData.email,
        name: parsedData.name,
        eventTitle: 'Stadium 25',
        eventDate: parsedData.chooseYour === 'Friday' ? 'Friday August 8 2025' : 'Saturday August 9 2025',
        invoiceNo: parsedData.invoiceNo,
        qrDataUrl: qrDataUrl,
        chooseYour: parsedData.chooseYour // This comes from webhook parsing!
      };
      
      console.log('‚úÖ Email data prepared:');
      console.log(`   To: ${emailData.to}`);
      console.log(`   Name: ${emailData.name}`);
      console.log(`   Event Date: ${emailData.eventDate}`);
      console.log(`   Invoice: ${emailData.invoiceNo}`);
      console.log(`   Choose Your: ${emailData.chooseYour}`);
      
      // STEP 4: Send email
      console.log('\nüîÑ STEP 4: Sending email...');
      await emailService.sendTicketEmail(emailData);
      console.log(`‚úÖ Email sent successfully for booking #${i + 1}!`);
      
      results.push({
        booking: i + 1,
        invoice: parsedData.invoiceNo,
        night: parsedData.chooseYour,
        status: 'success',
        webhookParsed: true,
        chooseYourParsed: !!parsedData.chooseYour
      });
      
      // Wait 1 second between emails
      if (i < simulatedWebhookData.length - 1) {
        console.log('‚è≥ Waiting 1 second before next webhook...');
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
    } catch (error) {
      console.error(`‚ùå Failed to process booking #${i + 1}:`, error.message);
      results.push({
        booking: i + 1,
        invoice: 'unknown',
        night: 'unknown',
        status: 'failed',
        error: error.message,
        webhookParsed: false,
        chooseYourParsed: false
      });
    }
  }
  
  // Summary
  console.log('\nüéâ FULL PIPELINE TEST COMPLETED!');
  console.log('=================================');
  
  const successful = results.filter(r => r.status === 'success');
  const failed = results.filter(r => r.status === 'failed');
  const chooseYourWorking = results.filter(r => r.chooseYourParsed);
  
  console.log(`‚úÖ Successful: ${successful.length}/${simulatedWebhookData.length}`);
  console.log(`‚ùå Failed: ${failed.length}/${simulatedWebhookData.length}`);
  console.log(`üéØ chooseYour Parsed: ${chooseYourWorking.length}/${simulatedWebhookData.length}`);
  
  if (successful.length > 0) {
    console.log('\n‚úÖ Successfully processed webhooks for:');
    successful.forEach(r => {
      console.log(`   - Booking #${r.booking}: Invoice ${r.invoice} (${r.night}) ${r.chooseYourParsed ? 'üéØ' : '‚ùå'}`);
    });
  }
  
  if (failed.length > 0) {
    console.log('\n‚ùå Failed to process webhooks for:');
    failed.forEach(r => {
      console.log(`   - Booking #${r.booking}: ${r.error}`);
    });
  }
  
  console.log('\nüîç WHAT TO CHECK IN YOUR EMAILS:');
  console.log('=================================');
  console.log('You should receive 4 separate emails, each with:');
  console.log('1. ‚úÖ Correct Friday/Saturday dates from webhook parsing:');
  console.log('   - Emails 1 & 2: "Friday August 8 2025"');
  console.log('   - Emails 3 & 4: "Saturday August 9 2025"');
  console.log('2. ‚úÖ Unique QR codes that scan to:');
  console.log('   - Email 1: "000029"');
  console.log('   - Email 2: "000027"'); 
  console.log('   - Email 3: "000026"');
  console.log('   - Email 4: "000025"');
  console.log('3. ‚úÖ All registration details parsed from webhook');
  console.log('4. ‚úÖ Professional formatting with Youth Alive branding');
  
  console.log('\nüéØ KEY SUCCESS INDICATORS:');
  console.log('===========================');
  console.log('‚úÖ chooseYour field successfully parsed from webhook');
  console.log('‚úÖ Correct Friday/Saturday dates displayed in emails');
  console.log('‚úÖ QR codes generated and attached');
  console.log('‚úÖ Full webhook ‚Üí email pipeline working');
  
  return results;
}

// Run the test
async function runFullPipelineTest() {
  try {
    const results = await testFullPipelineForBijin();
    
    console.log('\nüìã FINAL SUMMARY:');
    console.log('==================');
    console.log('‚úÖ 4 webhook simulations processed');
    console.log('‚úÖ Full pipeline tested: Webhook ‚Üí Parse ‚Üí QR ‚Üí Email');
    console.log('‚úÖ chooseYour field parsing tested');
    console.log('‚úÖ Friday/Saturday detection tested');
    
    const successful = results.filter(r => r.status === 'success');
    const chooseYourWorking = results.filter(r => r.chooseYourParsed);
    
    if (successful.length === simulatedWebhookData.length && chooseYourWorking.length === simulatedWebhookData.length) {
      console.log('\nüéâ ALL PIPELINE TESTS PASSED! The QR code fix is working correctly.');
      console.log('üöÄ Ready to proceed with batch resend for actual Stadium 25 registrants.');
    } else {
      console.log(`\n‚ö†Ô∏è  ${successful.length}/${simulatedWebhookData.length} pipeline tests passed.`);
      console.log(`‚ö†Ô∏è  ${chooseYourWorking.length}/${simulatedWebhookData.length} chooseYour parsing tests passed.`);
      console.log('üîß Review failed tests before proceeding with batch resend.');
    }
    
  } catch (error) {
    console.error('\nüí• Pipeline test suite failed:', error);
  }
}

// Run the test
if (require.main === module) {
  runFullPipelineTest()
    .then(() => {
      console.log('\n‚úÖ Full pipeline test completed!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nüí• Full pipeline test failed:', error);
      process.exit(1);
    });
}

module.exports = { testFullPipelineForBijin };
